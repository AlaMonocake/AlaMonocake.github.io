<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holy Grail War Simulator</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1 class="title">HOLY GRAIL WAR SIMULATOR</h1>
        <h2 id="day-counter">Day 1</h2>
    </header>
    
    <main>
        
        <div id="event-log" class="event-container">
            <!-- Events will be inserted here by JavaScript -->
        </div>
        
        <button class="button" id="next-day">Proceed to Next Day</button>
    </main>
    <script type="module" src="events.js"></script>
     <!-- The script to collect participants follows -->
     <script>
        function loadParticipants() {
    const storedData = localStorage.getItem("participants");

    if (!storedData) {
        console.error("No participants found in localStorage.");
        document.getElementById("event-log").innerHTML = "<p>No participants found. Please start from the index page.</p>";
        return [];
    }

    try {
        const participants = JSON.parse(storedData);
        console.log("Loaded Participants:", participants);

        if (!Array.isArray(participants)) {
            console.error("Participants data is invalid.");
            return [];
        }

        return participants;
    } catch (error) {
        console.error("Error parsing participants from localStorage:", error);
        return [];
    }
}

        function generateDayOneEvents(participants) {
            const eventLog = document.getElementById("event-log");
            let events = `<h2>Day 1: The Summoning</h2>`;

            const masters = participants.filter(p => p.type === "master");

    masters.forEach(master => {
        if (master.servantName && master.servantName !== "Unknown") {
            events += `<p><img src="${master.picture}" width="50"> <strong>${master.name}</strong> summons <strong>${master.servantName}</strong>.</p>`;
        } else {
            events += `<p><img src="${master.picture}" width="50"> <strong>${master.name}</strong> summons an unknown servant.</p>`;
        }
    });

    eventLog.innerHTML = events;
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("Simulation page loaded");
    const participants = loadParticipants();

    if (Array.isArray(participants) && participants.length > 0) {
        generateDayOneEvents(participants);
    } else {
        console.warn("No valid participants loaded.");
    }
});

//WE'RE DONE WITH THE ABOVE CODE. Now the event simulation code follows

import { eventPool } from './events.js'; // Adjust the path if needed
function runRandomEvent() {
    // Ensure there are alive participants before running events
    const aliveMasters = participants.filter(p => p.type === "master" && p.status === "alive");
    const aliveServants = participants.filter(p => p.type === "servant" && p.status === "alive");

    if (aliveMasters.length === 0) return;  // No more masters, game over
    if (aliveServants.length === 0) return;  // No more servants, game over

    // Randomly pick an event from the event pool
    const event = eventPool[Math.floor(Math.random() * eventPool.length)];

    // Select random participants for the event
    let selected = [];
    for (const targetType of event.targets) {
        const pool = participants.filter(p => p.type === targetType && p.status === "alive");
        if (pool.length === 0) return;  // Skip if no eligible targets
        const pick = pool[Math.floor(Math.random() * pool.length)];
        selected.push(pick);
    }

    // Apply the event's effect
    event.effect(participants, ...selected);

    // Log the event description
    const description = event.description
        .replace("{master}", selected[0]?.name || "Unknown")
        .replace("{servant1}", selected[0]?.name || "Unknown")
        .replace("{servant2}", selected[1]?.name || "Unknown");

    console.log("Event:", description);
    // Optionally log the event to a history
    logEvent(description);

    //THE EVENT HISTORY FOR DEBUGGING
    let eventHistory = [];
    function logEvent(description) {
    eventHistory.push({ description, timestamp: new Date() });
    console.log("Logged Event:", description);
}

}

    </script>
</body>
</html>
